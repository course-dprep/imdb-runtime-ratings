---
title: "IMDb Data Cleaning and Exploration"
  output:
  pdf_document: default
  html_document: default
---
# Necessary Packages
```{r}
install.packages("dplyr")
install.packages("readr")
install.packages("fs")
install.packages("data.table")
install.packages("R.utils")
install.packages("stringr")
install.packages("ggplot2")
install.packages("forcats")
install.packages("tidyr")
install.packages("tinytex")

# Load libraries
library(dplyr)
library(readr)
library(fs)
library(data.table)
library(R.utils)
library(stringr)
library(tinytex)
library(ggplot2)
library(forcats)
library(tidyr)
```

# Data Pulling Script
```{r}
base_url <- "https://datasets.imdbws.com/"                 # Base URL for IMDb datasets
files <- c("title.basics.tsv.gz", "title.ratings.tsv.gz")  # IMDb dataset files to download

# Set up output directory 
out_dir <- "data/imdb"              # Folder to store the downloaded files
dir_create(out_dir)                 # Create the directory if it doesn't already exist

# Download IMDb files if not already present locally
for (f in files) {
  dest <- file.path(out_dir, f)           # Full local path for each file
  if (!file_exists(dest)) {               # Only download if file is missing
    download.file(paste0(base_url, f),    # Construct the full URL
    destfile = dest,                      # Where to save it locally
    mode = "wb",                          # Write in binary mode (important for .gz files)
    quiet = TRUE)                         # Suppress download messages

  }
}

# Load IMDb datasets using fread() for efficiency
basics   <- fread(file.path(out_dir, "title.basics.tsv.gz"),
                  sep = "\t", na.strings = "\\N", quote = "")
ratings  <- fread(file.path(out_dir, "title.ratings.tsv.gz"),
                  sep = "\t", na.strings = "\\N", quote = "")
```

# Quick data exploration
```{r}
# Overview of datasets
summary(ratings)
summary(basics)
str(ratings)
str(basics)

# Convert columns stored as character to numeric for easier analysis
basics$startYear <- as.numeric(basics$startYear)
basics$runtimeMinutes <- as.numeric(basics$runtimeMinutes)
```

# Selecting relevant columns
```{r}
basics <- basics %>%
  select(
    tconst,           # Unique title identifier (key for merging)
    titleType,        # Type of the title (movie, short, tvSeries, etc.)
    primaryTitle,     # Main title
    startYear,        # Release year
    runtimeMinutes,   # Duration in minutes
    genres            # List of genres
  ) %>%
  filter(
    titleType == "movie",          # Keep only feature films
    startYear >= 2011,             # Released from 2011 onwards
    startYear <= 2020              # Up to 2020
  )
```

# Checking missing values and patterns
```{r}
# Count and proportion of missing runtimes
sum(is.na(basics$runtimeMinutes))   
mean(is.na(basics$runtimeMinutes))  

# Create indicator for missing runtimes
basics$runtime_missing <- is.na(basics$runtimeMinutes)
table(basics$runtime_missing)

# Check association of missingness with other variables
basics_long <- basics %>%
  separate_rows(genres, sep = ",") %>%
  mutate(runtime_missing = is.na(runtimeMinutes)) %>%
  mutate(genres = fct_lump(genres, n = 10))

# Merge datasets
merged_df <- merge(basics, ratings, by = "tconst") %>%
  mutate(runtime_missing = is.na(runtimeMinutes)) 
``` 

# Visualizing missing data patterns
```{r}
# Missingness by release year
ggplot(basics, aes(x = startYear, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of missing runtimes by release year",
       y = "Proportion")

# Missingness by genre
ggplot(basics_long, aes(x = genres, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Missing Runtimes by Top 10 Genres",
       x = "Genre",
       y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Missingness by popularity (number of votes)
merged_df %>%
  mutate(vote_bin = cut(numVotes,
                        breaks = c(0, 100, 1000, 10000, 100000, Inf),
                        labels = c("0–100", "101–1k", "1k–10k", "10k–100k", "100k+"))) %>%
  ggplot(aes(x = vote_bin, fill = is.na(runtimeMinutes))) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of Missing Runtimes by Vote Category",
       x = "Vote Category",
       y = "Proportion")

# Missingness by average rating
ggplot(merged_df, aes(x = averageRating, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion of missing runtimes by Average Rating",
       y = "Proportion")
```

# Statistical tests & transformations
```{r}
# Statistical tests of missingness patterns
chisq.test(table(basics$startYear, basics$runtime_missing))
chisq.test(table(basics_long$genres, basics_long$runtime_missing))

# Create log-transformed and standardized variables
merged_df <- merged_df %>%
  mutate(
    log10_numVotes = log10(numVotes),
    Runtime10 = (runtimeMinutes - mean(runtimeMinutes, na.rm = TRUE)) / 10
  )
```

# Filtering genres and votes
```{r}
merged_df <- merged_df %>%
  filter(str_detect(genres, "Comedy") |
         str_detect(genres, "Action") |
         str_detect(genres, "Adventure")) %>%
  filter(is.na(runtimeMinutes) |
           runtimeMinutes >= 30) %>%           # Keep NA run times, exclude very short films
  filter(numVotes >= 50)                       # Keep NA and films with few votes
```

# Imputing missing runtimes
```{r}
#  Impute missing runtimes by Genre x YearGroup 
merged_df <- merged_df %>%
  mutate(
    year_group = case_when(
      startYear >= 2011 & startYear <= 2015 ~ "2011-2015",
      startYear >= 2016 & startYear <= 2020 ~ "2016-2020"
    )
  ) %>%
  group_by(genres, year_group) %>%
  mutate(runtimeMinutes = if_else(
    is.na(runtimeMinutes),
    median(runtimeMinutes, na.rm = TRUE),
    runtimeMinutes
  )) %>%
  ungroup()
```
