---
title: "IMDb Data Cleaning and Exploration"
output:
  html_document:
    code_folding: hide
    df_print: paged
    toc: true
    toc_float: true
knitr:
  opts_chunk:
    echo: false
    message: false
    warning: false
---
## Necessary Packages
The following R packages are used for importing, cleaning, and analyzing the IMDb data.  
`dplyr`, `tidyr`, and `stringr` support data manipulation and cleaning;  
`data.table` and `readr` improve performance when reading large datasets;  
`ggplot2` is used for visualizations;  
and the remaining packages assist with file management and report generation.
```{r packages, warning=FALSE, message=FALSE}
#
packages <- c("dplyr", "readr", "fs", "data.table", "R.utils", 
              "stringr", "tinytex", "ggplot2", "forcats", "tidyr")
installed <- packages %in% installed.packages()[, "Package"]
if (any(!installed)) install.packages(packages[!installed])

# Load libraries
library(dplyr)
library(readr)
library(fs)
library(data.table)
library(R.utils)
library(stringr)
library(tinytex)
library(ggplot2)
library(forcats)
library(tidyr)
```

## Data Pulling Script
This script retrieves the IMDb datasets from the official source, saves them locally, and loads them into R for further analysis.
```{r}
base_url <- "https://datasets.imdbws.com/"                 # Base URL for IMDb datasets
files <- c("title.basics.tsv.gz", "title.ratings.tsv.gz")  # IMDb dataset files to download

# Set up output directory 
out_dir <- "data/imdb"              # Folder to store the downloaded files
dir_create(out_dir)                 # Create the directory if it doesn't already exist

# Download IMDb files if not already present locally
for (f in files) {
  dest <- file.path(out_dir, f)           # Full local path for each file
  if (!file_exists(dest)) {               # Only download if file is missing
    download.file(paste0(base_url, f),    # Construct the full URL
    destfile = dest,                      # Where to save it locally
    mode = "wb",                          # Write in binary mode (important for .gz files)
    quiet = TRUE)                         # Suppress download messages

  }
}

# Load IMDb datasets using fread() for efficiency
basics   <- fread(file.path(out_dir, "title.basics.tsv.gz"),
                  sep = "\t", na.strings = "\\N", quote = "")
ratings  <- fread(file.path(out_dir, "title.ratings.tsv.gz"),
                  sep = "\t", na.strings = "\\N", quote = "")
```

## Quick data exploration
This section provides an initial overview of the IMDb datasets to understand their structure and key characteristics.  
It summarizes the number of observations, variable types, and the general distribution of ratings, votes, and movie attributes.  
This step helps identify potential data quality issues, such as missing or inconsistent values, before further cleaning and analysis.

```{r}
# Overview of datasets
summary(ratings)
summary(basics)
str(ratings)
str(basics)

# Convert columns stored as character to numeric for easier analysis
basics$startYear <- as.numeric(basics$startYear)
basics$runtimeMinutes <- as.numeric(basics$runtimeMinutes)
```

## Selecting relevant columns
This section filters the IMDb dataset to include only feature films released between 2011 and 2020, keeping key variables such as title, year, runtime, and genre.
```{r}
basics <- basics %>%
  select(
    tconst,           # Unique title identifier (key for merging)
    titleType,        # Type of the title (movie, short, tvSeries, etc.)
    primaryTitle,     # Main title
    startYear,        # Release year
    runtimeMinutes,   # Duration in minutes
    genres            # List of genres
  ) %>%
  filter(
    titleType == "movie",          # Keep only feature films
    startYear >= 2011,             # Released from 2011 onwards
    startYear <= 2020              # Up to 2020
  )
```

## Checking missing values and patterns
This section examines the extent and distribution of missing runtime values in the dataset.  
The results show that **36,055** movies (about **20.9%** of all feature films between 2011 and 2020) have missing runtime information.  
A logical indicator variable (`runtime_missing`) is created to flag these cases, and the data are further reshaped to explore whether missing values are related to other factors such as genre or release year.  
Understanding these patterns helps determine whether the missing data are random or systematically associated with specific types of movies.
```{r}
# Count and proportion of missing runtimes
sum(is.na(basics$runtimeMinutes))   
mean(is.na(basics$runtimeMinutes))  

# Create indicator for missing runtimes
basics$runtime_missing <- is.na(basics$runtimeMinutes)
table(basics$runtime_missing)

# Check association of missingness with other variables
basics_long <- basics %>%
  separate_rows(genres, sep = ",") %>%
  mutate(runtime_missing = is.na(runtimeMinutes)) %>%
  mutate(genres = fct_lump(genres, n = 10))

# Merge datasets
merged_df <- merge(basics, ratings, by = "tconst") %>%
  mutate(runtime_missing = is.na(runtimeMinutes)) 
``` 

## Visualizing missing data patterns
This section visualizes the distribution of missing runtime values across different release years. 

Figure 1 shows the **proportion of movies with and without missing runtimes** for each year between 2011 and 2020.  
The turquoise segments represent films with missing runtime information.  
The plot indicates that the share of missing runtimes slightly increases for more recent years, suggesting that newer titles in the dataset are somewhat less complete, possibly because not all metadata have been updated yet.
```{r}
# Missingness by release year
ggplot(basics, aes(x = startYear, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Figure 1; Proportion of missing runtimes by release year",
       y = "Proportion")
```

The figure below illustrates how missing runtime values are distributed across the ten most common movie genres.  
The turquoise segments represent the share of films lacking runtime information.  
The results show that missing runtimes are not evenly distributed: genres such as **Documentary** and **Biography** have a noticeably higher proportion of missing values, while **Action** and **Comedy** films tend to have more complete runtime data.  
This pattern suggests that certain types of movies—particularly documentaries and biographical films—may be less consistently documented in the IMDb database.
```{r}
# Missingness by genre
ggplot(basics_long, aes(x = genres, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Figure 2; Proportion of Missing Runtimes by Top 10 Genres",
       x = "Genre",
       y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

Figure 3 examines whether the likelihood of missing runtime information differs by movie popularity, as measured by the number of IMDb votes.  
The turquoise bars represent films without recorded runtimes.  
The plot shows that **movies with very few votes (0–100)** have a noticeably higher proportion of missing runtimes, while films with more than 1,000 votes almost never lack this information.  
This suggests that missing data are more common among lesser-known or recently added titles that have not yet accumulated many viewer ratings.
```{r}
# Missingness by popularity (number of votes)
merged_df %>%
  mutate(vote_bin = cut(numVotes,
                        breaks = c(0, 100, 1000, 10000, 100000, Inf),
                        labels = c("0–100", "101–1k", "1k–10k", "10k–100k", "100k+"))) %>%
  ggplot(aes(x = vote_bin, fill = is.na(runtimeMinutes))) +
  geom_bar(position = "fill") +
  labs(title = "Figure 3; Proportion of Missing Runtimes by Vote Category",
       x = "Vote Category",
       y = "Proportion")
```

The last figure explores whether the proportion of missing runtime values varies across different IMDb rating levels.  
The turquoise segments represent movies without recorded runtimes.  
The results show that **films with very low (below 3)** or **very high (above 8)** ratings have a slightly higher share of missing runtimes, while movies with mid-range ratings (around 5–7) tend to have more complete data.  
This pattern may indicate that both niche or less popular films and highly rated, possibly newly released titles, are less consistently documented in the database.
```{r}
# Missingness by average rating
ggplot(merged_df, aes(x = averageRating, fill = runtime_missing)) +
  geom_bar(position = "fill") +
  labs(title = "Figure 4; Proportion of missing runtimes by Average Rating",
       y = "Proportion")
```

## Statistical tests & transformations
This section uses chi-squared tests to determine whether the occurrence of missing runtime data is systematically related to other variables.  
The results show highly significant associations (p < 0.001) between missing runtimes and both **release year** and **genre**, indicating that missingness is not random.  
This suggests that certain genres or years are more prone to missing data, which should be taken into account when handling or imputing missing values.  

In addition, new variables are created to prepare the data for further analysis
```{r}
# Statistical tests of missingness patterns
chisq.test(table(basics$startYear, basics$runtime_missing))
chisq.test(table(basics_long$genres, basics_long$runtime_missing))

# Create log-transformed and standardized variables
merged_df <- merged_df %>%
  mutate(
    log10_numVotes = log10(numVotes),
    Runtime10 = (runtimeMinutes - mean(runtimeMinutes, na.rm = TRUE)) / 10
  )
```

## Filtering genres and votes
The dataset is filtered to include only Action, Adventure, and Comedy movies.  
Short films under 30 minutes are excluded, and movies with fewer than 50 votes are removed to focus on well-documented, feature-length titles.
```{r}
merged_df <- merged_df %>%
  filter(str_detect(genres, "Comedy") |
         str_detect(genres, "Action") |
         str_detect(genres, "Adventure")) %>%
  filter(is.na(runtimeMinutes) |
           runtimeMinutes >= 30) %>%           # Keep NA run times, exclude very short films
  filter(numVotes >= 50)                       # Keep NA and films with few votes
```

## Imputing missing runtimes
In this section addresses the missing runtime values by applying a median imputation method.  
Movies are grouped by **genre** and **release period** (2011–2015 or 2016–2020), and the median runtime within each group is calculated.  
For movies with missing runtime information, the missing value is replaced by the corresponding group median.  
This approach preserves realistic runtime distributions within genres and time periods, minimizing bias that could arise from using a single overall average.  
The result is a more complete dataset that maintains internal consistency across film types and release years.
```{r}
#  Impute missing runtimes by Genre x YearGroup 
merged_df <- merged_df %>%
  mutate(
    year_group = case_when(
      startYear >= 2011 & startYear <= 2015 ~ "2011-2015",
      startYear >= 2016 & startYear <= 2020 ~ "2016-2020"
    )
  ) %>%
  group_by(genres, year_group) %>%
  mutate(runtimeMinutes = if_else(
    is.na(runtimeMinutes),
    median(runtimeMinutes, na.rm = TRUE),
    runtimeMinutes
  )) %>%
  ungroup()
```
