## Loading packages
```{r}
library(dplyr)
library(tidyverse)
library(stringr)
library(car)
library(scales)
library(knitr)
```


## Regression Analysis

```{r}
# Model: Rating ~ Runtime10 * Genre + Runtime10 * YearGroup + logVotes
# modeling helpers
  mutate(
    logVotes  = log10(numVotes),
    Runtime10 = (runtimeMinutes - mean(runtimeMinutes, na.rm = TRUE)) / 10
  )

model <- lm(averageRating ~ Runtime10*Genre + Runtime10*YearGroup + logVotes,
            data = merged_df)
summary(model)

```
```{r}
# β1: slope of Runtime10 for the reference group (Comedy, 2011–2015)
beta1 <- coef(model)[["Runtime10"]]

# Genre interactions change the slope relative to Comedy:
# β5 (Runtime10 × Adventure), β6 (Runtime10 × Action)
beta5 <- coef(model)[["Runtime10:GenreAdventure"]]
beta6 <- coef(model)[["Runtime10:GenreAction"]]

# Year interaction changes the slope for 2016–2020 vs 2011–2015: β7
beta7 <- coef(model)[["Runtime10:YearGroup2016-2020"]]

# Main effects:
# β2, β3 (genre level shifts vs Comedy), β4 (2016–2020 shift vs 2011–2015)
beta2 <- coef(model)[["GenreAdventure"]]
beta3 <- coef(model)[["GenreAction"]]
beta4 <- coef(model)[["YearGroup2016-2020"]]

# Control: β8 (effect of a 10x increase in votes)
beta8 <- coef(model)[["logVotes"]]

round(c(beta1=beta1,beta2=beta2,beta3=beta3,beta4=beta4,beta5=beta5,beta6=beta6,beta7=beta7,beta8=beta8), 3)

```

# Checking Assumptions and Providing Fixes if Necessary
```{r}
model_df$residuals_lm <- resid(model)

leveneTest(residuals_lm ~ Genre*YearGroup, data = model_df, center = mean)

if (!requireNamespace("sandwich", quietly = TRUE)) install.packages("sandwich")
if (!requireNamespace("lmtest", quietly = TRUE)) install.packages("lmtest")
library(sandwich)
library(lmtest)

# HC3 is a common choice
robust_se <- vcovHC(model, type = "HC3")
coeftest(model, vcov = robust_se)

ks.test(model$residuals, "pnorm",
        mean = mean(model$residuals),
        sd   = sd(model$residuals))

# Shapiro–Wilk (note: with large n it almost always rejects)
shapiro.test(sample(model$residuals, size = min(5000, length(model$residuals))))

vif(model)

```

## Descriptive analyses

# Number of films per year
```{r}
merged_df %>%
  count(startYear) %>%
  ggplot(aes(x = startYear, y = n)) +
  geom_col(fill = "steelblue") +
  scale_x_continuous(labels = number_format(accuracy = 1)) +
  labs(title = "Number of Films per Year (2011–2020)",
       x = "Year", y = "Number of Films")
```

# Average rating per year
```{r}
merged_df %>%
  group_by(startYear) %>%
  summarise(mean_rating = mean(averageRating, na.rm = TRUE)) %>%
  ggplot(aes(x = startYear, y = mean_rating)) +
  geom_line(color = "darkred", size = 1) +
  scale_x_continuous(labels = number_format(accuracy = 1)) +
  labs(title = "Average IMDb Rating per Year",
       x = "Year", y = "Average Rating")
```

# Distribution of ratings
```{r}
merged_df %>%
  ggplot(aes(x = averageRating)) +
  geom_histogram(binwidth = 0.2, fill = "goldenrod", color = "white") +
  labs(title = "Distribution of IMDb Ratings",
       x = "Rating", y = "Number of Films")
```

# Average rating per genre
```{r}
merged_df %>%
  separate_rows(genres, sep = ",") %>%
  filter(genres %in% c("Action","Comedy","Adventure")) %>%
  group_by(genres) %>%
  summarise(mean_rating = mean(averageRating, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(genres, -mean_rating), y = mean_rating, fill = genres)) +
  geom_col() +
  labs(title = "Average IMDb Rating by Genre",
       x = "Genre", y = "Average Rating")
```

# Distribution of votes (log scale)
```{r}
merged_df %>%
  ggplot(aes(x = numVotes)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  scale_x_log10() +
  labs(title = "Distribution of Number of Votes (log scale)",
       x = "Number of Votes (log10)", y = "Number of Films")
```

# Average number of votes per genre
```{r}
merged_df %>%
  separate_rows(genres, sep = ",") %>%
  filter(genres %in% c("Action","Comedy","Adventure")) %>%
  group_by(genres) %>%
  summarise(mean_votes = mean(numVotes, na.rm = TRUE)) %>%
  ggplot(aes(x = reorder(genres, -mean_votes), y = mean_votes, fill = genres)) +
  geom_col() +
  labs(title = "Average Number of Votes by Genre",
       x = "Genre", y = "Average Votes")
```

# Distribution of runtimes
```{r}
merged_df %>%
  ggplot(aes(x = runtimeMinutes)) +
  geom_histogram(binwidth = 10, fill = "darkgreen", color = "white") +
  labs(title = "Distribution of Runtimes",
       x = "Runtime (minutes)", y = "Number of Films")
```

# Average runtime per year
```{r}
merged_df %>%
  group_by(startYear) %>%
  summarise(mean_runtime = mean(runtimeMinutes, na.rm = TRUE)) %>%
  ggplot(aes(x = startYear, y = mean_runtime)) +
  geom_line(color = "darkblue", size = 1) +
  scale_x_continuous(labels = number_format(accuracy = 1)) +
  labs(title = "Average Runtime per Year",
       x = "Year", y = "Runtime (minutes)")
```

# Runtime distribution by genre
```{r}
merged_df %>%
  separate_rows(genres, sep = ",") %>%
  filter(genres %in% c("Action", "Comedy", "Adventure")) %>%
  ggplot(aes(x = genres, y = runtimeMinutes, fill = genres)) +
  geom_boxplot() +
  labs(title = "Runtime Distribution by Genre",
       x = "Genre", y = "Runtime (minutes)")
```

# Heatmap: Average rating per genre per year
```{r}
merged_df %>%
  separate_rows(genres, sep = ",") %>%
  filter(genres %in% c("Action","Comedy","Adventure")) %>%
  group_by(startYear, genres) %>%
  summarise(mean_rating = mean(averageRating, na.rm = TRUE)) %>%
  ggplot(aes(x = startYear, y = genres, fill = mean_rating)) +
  geom_tile(color = "white") +
  scale_fill_gradient(low = "lightyellow", high = "red") +
  scale_x_continuous(labels = number_format(accuracy = 1)) +
  labs(title = "Average IMDb Rating per Genre per Year",
       x = "Year", y = "Genre", fill = "Average Rating")
```

# Summary by genre
```{r}
merged_df %>%
  separate_rows(genres, sep = ",") %>%
  filter(genres %in% c("Action","Comedy","Adventure")) %>%
  group_by(genres) %>%
  summarise(
    n_films = n(),
    mean_rating = mean(averageRating, na.rm = TRUE),
    sd_rating = sd(averageRating, na.rm = TRUE),
    mean_votes = mean(numVotes, na.rm = TRUE),
    mean_runtime = mean(runtimeMinutes, na.rm = TRUE)
  )
```

# Summary by year
```{r}
merged_df %>%
  group_by(startYear) %>%
  summarise(
    n_films = n(),
    mean_rating = mean(averageRating, na.rm = TRUE),
    mean_votes = mean(numVotes, na.rm = TRUE),
    mean_runtime = mean(runtimeMinutes, na.rm = TRUE)
  ) 
```